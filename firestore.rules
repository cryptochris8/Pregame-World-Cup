rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPER FUNCTIONS ====================

    function isAuth() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isAuth() && request.auth.token.admin == true;
    }

    // Check if the current user is a participant of a given chat document
    function isChatParticipant(chatId) {
      return isAuth() && request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participantIds;
    }

    // ==================== USER DATA ====================

    // User favorites - own data only
    match /userFavorites/{userId} {
      allow read, write: if isOwner(userId);
    }

    // User profiles - public read, own write
    match /users/{userId} {
      allow read: if isAuth();
      allow write: if isOwner(userId);

      match /interactions/{interactionId} {
        allow read, write: if isOwner(userId);
      }

      match /learned_preferences/{prefId} {
        allow read, write: if isOwner(userId);
      }
    }

    // User interactions
    match /user_interactions/{interactionId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.auth.uid == request.resource.data.userId;
      allow update, delete: if isAuth() && request.auth.uid == resource.data.userId;
    }

    // User preferences - own data only
    match /user_preferences/{userId} {
      allow read, write: if isOwner(userId);
    }

    // User profiles (world cup specific) - public read, own write
    match /user_profiles/{userId} {
      allow read: if isAuth();
      allow write: if isOwner(userId);
    }

    // Notification preferences - own data only
    match /notification_preferences/{userId} {
      allow read, write: if isOwner(userId);
    }

    // User notification preferences - own data only
    match /user_notification_preferences/{userId} {
      allow read, write: if isOwner(userId);
    }

    // User behavior summary - own data only (AI learning)
    match /user_behavior_summary/{userId} {
      allow read, write: if isOwner(userId);
    }

    // Venue interactions - own data only (user learning)
    match /venue_interactions/{docId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.auth.uid == request.resource.data.userId;
      allow update, delete: if isAuth() && request.auth.uid == resource.data.userId;
    }

    // Team preferences - own data only (user learning)
    match /team_preferences/{docId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.auth.uid == request.resource.data.userId;
      allow update, delete: if isAuth() && request.auth.uid == resource.data.userId;
    }

    // Match reminders - own data only (via userId field)
    match /match_reminders/{reminderId} {
      allow read, write: if isAuth() && request.auth.uid == resource.data.userId;
      allow create: if isAuth() && request.auth.uid == request.resource.data.userId;
    }

    // ==================== TOURNAMENT REFERENCE DATA ====================
    // Read-only for authenticated users, written by Cloud Functions/admin only

    match /worldcup_matches/{matchId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /national_teams/{teamId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /players/{playerId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /worldcup_players/{playerId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /managers/{managerId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /groups/{groupId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /brackets/{bracketId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /matchSummaries/{summaryId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /headToHead/{docId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /worldCupHistory/{docId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /worldCupRecords/{docId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /schedules/{docId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // Games and venues - auth read, admin write
    match /games/{gameId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /venues/{venueId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // World Cup specific collections (used by Flutter app datasource)
    match /worldcup_teams/{teamId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /worldcup_groups/{groupId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /worldcup_bracket/{bracketId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    match /worldcup_venues/{venueId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // ==================== SOCIAL FEATURES ====================

    // Social profiles - public read, own write
    match /social_profiles/{userId} {
      allow read: if isAuth();
      allow write: if isOwner(userId);
    }

    // Social posts - public read, own create/update/delete
    match /social_posts/{postId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.auth.uid == request.resource.data.authorId;
      allow update, delete: if isAuth() && request.auth.uid == resource.data.authorId;
    }

    // Activities - public read, own create/update/delete
    match /activities/{activityId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.auth.uid == request.resource.data.authorId;
      allow update, delete: if isAuth() && request.auth.uid == resource.data.authorId;
    }

    // Activity likes - auth read, auth create/delete
    match /activity_likes/{likeId} {
      allow read: if isAuth();
      allow create, delete: if isAuth();
    }

    // Activity comments - auth read, auth create, own delete
    match /activity_comments/{commentId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow delete: if isAuth() && request.auth.uid == resource.data.authorId;
    }

    // Comments (general) - auth read, auth create, own delete
    match /comments/{commentId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow delete: if isAuth() && request.auth.uid == resource.data.authorId;
    }

    // Activity feed - auth read, own write
    match /activity_feed/{activityId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.auth.uid == request.resource.data.authorId;
      allow update, delete: if isAuth() && request.auth.uid == resource.data.authorId;
    }

    // Social activities - auth read, own write
    match /social_activities/{activityId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.auth.uid == request.resource.data.authorId;
      allow update, delete: if isAuth() && request.auth.uid == resource.data.authorId;
    }

    // Friend requests - participants can read/write
    match /friend_requests/{requestId} {
      allow read: if isAuth() &&
        (request.auth.uid == resource.data.senderId || request.auth.uid == resource.data.receiverId);
      allow create: if isAuth() && request.auth.uid == request.resource.data.senderId;
      allow update, delete: if isAuth() &&
        (request.auth.uid == resource.data.senderId || request.auth.uid == resource.data.receiverId);
    }

    // Friendships - only involved users (userId or friendId) can read/write
    match /friendships/{friendshipId} {
      allow read: if isAuth() &&
        (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.friendId);
      allow create: if isAuth() &&
        (request.auth.uid == request.resource.data.userId || request.auth.uid == request.resource.data.friendId);
      allow update, delete: if isAuth() &&
        (request.auth.uid == resource.data.userId || request.auth.uid == resource.data.friendId);
    }

    // Social connections - only involved users (fromUserId or toUserId) can access
    match /social_connections/{connectionId} {
      allow read: if isAuth() &&
        (request.auth.uid == resource.data.fromUserId || request.auth.uid == resource.data.toUserId);
      allow create: if isAuth() &&
        (request.auth.uid == request.resource.data.fromUserId || request.auth.uid == request.resource.data.toUserId);
      allow update, delete: if isAuth() &&
        (request.auth.uid == resource.data.fromUserId || request.auth.uid == resource.data.toUserId);
    }

    // Predictions - auth read, own write
    match /predictions/{predictionId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.auth.uid == request.resource.data.userId;
      allow update, delete: if isAuth() && request.auth.uid == resource.data.userId;
    }

    // Game predictions - auth read/write (leaderboard feature)
    match /game_predictions/{predictionId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if isAuth() && request.auth.uid == resource.data.userId;
    }

    // User predictions - own data
    match /user_predictions/{predictionId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if isAuth() && request.auth.uid == resource.data.userId;
    }

    // Prediction stats - own data only
    match /prediction_stats/{userId} {
      allow read: if isAuth();
      allow write: if isOwner(userId);
    }

    // User accuracy stats - own data only
    match /user_accuracy_stats/{userId} {
      allow read: if isAuth();
      allow write: if isOwner(userId);
    }

    // ==================== NOTIFICATIONS ====================

    // User notifications - own data only
    match /notifications/{notificationId} {
      allow read, write: if isAuth() && request.auth.uid == resource.data.userId;
      allow create: if isAuth();
    }

    // Internal notification collections - no client access (functions-only)
    match /sent_notifications/{docId} {
      allow read, write: if false;
    }

    match /friend_request_notifications/{docId} {
      allow read, write: if false;
    }

    // Message notifications - auth can create (trigger), no read
    match /message_notifications/{docId} {
      allow create: if isAuth();
      allow read, update, delete: if false;
    }

    // ==================== MESSAGING & CHAT ====================

    // Direct chats - only participants can read/write
    match /chats/{chatId} {
      allow read: if isAuth() && request.auth.uid in resource.data.participantIds;
      allow create: if isAuth() && request.auth.uid in request.resource.data.participantIds;
      allow update, delete: if isAuth() && request.auth.uid in resource.data.participantIds;
    }

    // Direct messages - only participants of the parent chat can read/write
    match /messages/{messageId} {
      allow read: if isAuth() && isChatParticipant(resource.data.chatId);
      allow create: if isAuth() && isChatParticipant(request.resource.data.chatId)
        && request.auth.uid == request.resource.data.senderId;
      allow update, delete: if isAuth() && isChatParticipant(resource.data.chatId);
    }

    // Match chats with subcollections
    match /match_chats/{chatId} {
      allow read, write: if isAuth();

      match /messages/{messageId} {
        allow read, write: if isAuth();
      }

      match /participants/{userId} {
        allow read, write: if isAuth();
      }
    }

    // User chat settings - own data
    match /user_chat_settings/{settingId} {
      allow read, write: if isAuth();
    }

    // Typing indicators - only participants of the referenced chat can read/write
    match /typing_indicators/{indicatorId} {
      allow read: if isAuth() && isChatParticipant(resource.data.chatId);
      allow create: if isAuth() && isChatParticipant(request.resource.data.chatId)
        && request.auth.uid == request.resource.data.userId;
      allow update: if isAuth() && isChatParticipant(resource.data.chatId)
        && request.auth.uid == resource.data.userId;
      allow delete: if isAuth() && isChatParticipant(resource.data.chatId)
        && request.auth.uid == resource.data.userId;
    }

    // ==================== WATCH PARTIES ====================

    match /watch_parties/{partyId} {
      allow read: if isAuth();
      allow create: if isAuth() && request.auth.uid == request.resource.data.hostId;
      allow update, delete: if isAuth() && request.auth.uid == resource.data.hostId;

      match /members/{memberId} {
        allow read, write: if isAuth();
      }

      match /messages/{messageId} {
        allow read, write: if isAuth();
      }
    }

    // Watch party invites - only inviter or invitee can access
    match /watch_party_invites/{inviteId} {
      allow read: if isAuth() &&
        (request.auth.uid == resource.data.inviterId || request.auth.uid == resource.data.inviteeId);
      allow create: if isAuth() && request.auth.uid == request.resource.data.inviterId;
      allow update, delete: if isAuth() &&
        (request.auth.uid == resource.data.inviterId || request.auth.uid == resource.data.inviteeId);
    }

    // Watch party virtual payments - own read, functions-only write
    match /watch_party_virtual_payments/{paymentId} {
      allow read: if isAuth() && request.auth.uid == resource.data.userId;
      allow write: if isAdmin();
    }

    // ==================== VENUES & REVIEWS ====================

    // Venue reviews - auth read, own write
    match /venue_reviews/{reviewId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if isAuth() && request.auth.uid == resource.data.userId;
    }

    // Venue enhancements - auth read, own (ownerId) or admin write
    match /venue_enhancements/{venueId} {
      allow read: if isAuth();
      allow write: if isAdmin() || (isAuth() && request.auth.uid == resource.data.ownerId);
      allow create: if isAuth();
    }

    // AI recommendations - auth read, own write
    match /ai_recommendations/{recommendationId} {
      allow read: if isAuth();
      allow create: if isAuth();
      allow update, delete: if isAuth() && request.auth.uid == resource.data.userId;
    }

    // ==================== PAYMENTS & BILLING ====================

    // Fan accounts - own read, functions/admin write
    match /fans/{fanId} {
      allow read: if isAuth() && request.auth.uid == resource.data.userId;
      allow write: if isAdmin();
    }

    // Stripe customers - own read, functions/admin write
    match /stripe_customers/{docId} {
      allow read: if isAuth() && request.auth.uid == resource.data.userId;
      allow write: if isAdmin();
    }

    // World Cup fan passes - own read, functions/admin write
    match /world_cup_fan_passes/{userId} {
      allow read: if isOwner(userId);
      allow write: if isAdmin();
    }

    // World Cup venue purchases - own read, functions/admin write
    match /world_cup_venue_purchases/{docId} {
      allow read: if isAuth() && request.auth.uid == resource.data.userId;
      allow write: if isAdmin();
    }

    // ==================== MODERATION ====================

    // Reports - users can create and read own, admins can read/update all
    match /reports/{reportId} {
      allow create: if isAuth() && request.auth.uid == request.resource.data.reporterId;
      allow read: if isAuth() && request.auth.uid == resource.data.reporterId;
      allow read, update: if isAdmin();
    }

    // User sanctions - own read, admin write
    match /user_sanctions/{sanctionId} {
      allow read: if isAuth() && request.auth.uid == resource.data.usualId;
      allow read, write: if isAdmin();
    }

    // User moderation status - own read, admin write, auth can increment report count
    match /user_moderation_status/{userId} {
      allow read: if isOwner(userId);
      allow read, write: if isAdmin();
      allow update: if isAuth() &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reportCount']);
    }

    // ==================== ADMIN ====================

    match /admin_users/{docId} {
      // Auth users can read to check their own admin status; only admins can write
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // Clearance users (beta testers, influencers, friends & family)
    match /clearance_users/{docId} {
      // Auth users can read to check their own clearance status; only admins can write
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // Admin collection (alternate name used in Flutter admin service)
    match /admins/{docId} {
      allow read, write: if isAdmin();
    }

    // Admin stats dashboard
    match /admin_stats/{docId} {
      allow read, write: if isAdmin();
    }

    // Admin audit logs
    match /admin_logs/{docId} {
      allow read, write: if isAdmin();
    }

    // Feature flags - admin read/write, auth read for checking flags
    match /feature_flags/{flagId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // Broadcast notifications - admin only
    match /broadcast_notifications/{docId} {
      allow read: if isAuth();
      allow write: if isAdmin();
    }

    // ==================== DEV ARTIFACTS (DENY ALL) ====================

    match /testWrites/{docId} {
      allow read, write: if false;
    }

    // ==================== DEFAULT DENY ====================
    // No catch-all rule. Any collection not explicitly listed above is denied.
  }
}
