rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow users to read and write their own favorite teams
    match /userFavorites/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow users to read and write their own user profiles
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      // Allow reading other users' public profile data
      allow read: if request.auth != null;
      
      // Allow reading of user interactions within user documents
      match /interactions/{interactionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Allow users to read and write their own user interactions
    match /user_interactions/{interactionId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // Allow reading all interactions for development
      allow read: if request.auth != null;
    }
    
    // Allow authenticated users to read and write game schedule data (for development)
    match /games/{gameId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow authenticated users to read and write venue data (for development)
    match /venues/{venueId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow users to read and write social features (friends, posts, etc.)
    match /social_profiles/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow users to read public posts but only write their own
    match /social_posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.authorId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.authorId;
    }
    
    // Allow users to manage their own friend requests and connections
    match /friend_requests/{requestId} {
      allow read, write: if request.auth != null && 
        (request.auth.uid == resource.data.senderId || request.auth.uid == resource.data.receiverId);
      allow create: if request.auth != null && request.auth.uid == request.resource.data.senderId;
      // Allow reading all friend requests for development
      allow read: if request.auth != null;
    }
    
    // Allow users to read/write their own notifications
    match /notifications/{notificationId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null;
    }
    
    // Allow users to read/write game predictions (more permissive for development)
    match /game_predictions/{predictionId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow users to read/write their own user predictions
    match /user_predictions/{predictionId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow authenticated users to read/write activity feed data
    match /activity_feed/{activityId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow authenticated users to read/write social activities
    match /social_activities/{activityId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow authenticated users to read/write chat data
    match /chats/{chatId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow authenticated users to read/write messages
    match /messages/{messageId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow authenticated users to read/write venue reviews and ratings
    match /venue_reviews/{reviewId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow authenticated users to read/write AI recommendations
    match /ai_recommendations/{recommendationId} {
      allow read, write: if request.auth != null;
    }
    
    // Allow authenticated users to read/write user preferences
    match /user_preferences/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ==================== MODERATION ====================

    // Reports - users can create reports and read their own reports
    match /reports/{reportId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.reporterId;
      allow read: if request.auth != null && request.auth.uid == resource.data.reporterId;
      // Admins can read and update all reports (admin check via custom claims)
      allow read, update: if request.auth != null && request.auth.token.admin == true;
    }

    // User sanctions - only admins can write, users can read their own
    match /user_sanctions/{sanctionId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.usualId;
      allow read, write: if request.auth != null && request.auth.token.admin == true;
    }

    // User moderation status - users can read their own, admins can read/write all
    match /user_moderation_status/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow read, write: if request.auth != null && request.auth.token.admin == true;
      // Allow increment of report count by any authenticated user (for reporting)
      allow update: if request.auth != null &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['reportCount']);
    }

    // Social connections - for block functionality
    match /social_connections/{connectionId} {
      allow read, write: if request.auth != null;
    }

    // User chat settings - for mute/archive functionality
    match /user_chat_settings/{settingId} {
      allow read, write: if request.auth != null;
    }

    // Typing indicators - real-time typing status
    match /typing_indicators/{indicatorId} {
      allow read, write: if request.auth != null;
    }

    // Watch parties - public read, authenticated write
    match /watch_parties/{partyId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == request.resource.data.hostId;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.hostId;
    }

    // Watch party invites
    match /watch_party_invites/{inviteId} {
      allow read, write: if request.auth != null;
    }

    // Default allow for development - REMOVE IN PRODUCTION
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
} 